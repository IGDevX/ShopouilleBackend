name: Update Manifest with new tag

on:
  repository_dispatch:
    types: [manifest-update]

jobs:
  update-manifest:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine target infrastructure
        id: determine-infra
        run: |
          set -euo pipefail
          branch="${{ github.event.client_payload.branch }}"
          echo "Received branch: ${branch}"

          case "${branch}" in
            dev|develop)
              echo "skip=true" >> "$GITHUB_OUTPUT"
              echo "dev branch detected; workflow will stop after this step."
              ;;
            staging)
              echo "INFRA=staging" >> "$GITHUB_ENV"
              ;;
            main)
              echo "INFRA=prod" >> "$GITHUB_ENV"
              ;;
            *)
              echo "Unknown branch '${branch}'" >&2
              exit 1
              ;;
          esac

      - name: Strip repository name
        if: steps.determine-infra.outputs.skip != 'true'
        run: |
          set -euo pipefail
          repo="${{ github.event.client_payload.repository }}"
          short="${repo#*-}"
          echo "STRIPPED_REPOSITORY=${short}" >> "$GITHUB_ENV"
          echo "Stripped repository: ${short}"

      - name: Update manifest
        if: steps.determine-infra.outputs.skip != 'true'
        run: |
          set -euo pipefail
          TAG="${{ github.event.client_payload.tag }}"
          REPOSITORY="${{ github.event.client_payload.repository }}"
          DEPLOYMENT_FILE="infra/${{ env.INFRA }}/applications/${{ env.STRIPPED_REPOSITORY }}/${{ env.STRIPPED_REPOSITORY }}-deployment.yaml"
          export TAG REPOSITORY DEPLOYMENT_FILE

          if [ ! -f "${DEPLOYMENT_FILE}" ]; then
            echo "Deployment file ${DEPLOYMENT_FILE} not found" >&2
            exit 1
          fi

          echo "Updating ${DEPLOYMENT_FILE} image to ghcr.io/${REPOSITORY}:${TAG}"

          python - <<'PY'
          import os, re, sys, pathlib
          deployment_file = pathlib.Path(os.environ["DEPLOYMENT_FILE"])
          repo = os.environ["REPOSITORY"]
          tag = os.environ["TAG"]
          text = deployment_file.read_text()
          pattern = rf"(image:\s*ghcr\.io/{re.escape(repo)}:)[^\s]+"
          if not re.search(pattern, text):
              raise SystemExit(f"Image line for ghcr.io/{repo} not found in {deployment_file}")
          text = re.sub(pattern, rf"\1{tag}", text, count=1)
          deployment_file.write_text(text)
          PY

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${DEPLOYMENT_FILE}"

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "chore: update ${STRIPPED_REPOSITORY} image to ${TAG}"
          git push
